var express = require('express');
var path = require('path');
var bodyParser = require('body-parser');
var compress = require('compression');

var slideshow = require('./../slideshow/slideshow');
var facebook = require('./../slideshow/facebook');

var serverSettings = {
  port: process.env.PORT || 3000
};

var app = express();
app.use(compress());
app.use(express.static(path.resolve('dist')));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

/***************************
 * Routes
 * **************************/

var times = [4260,5051,7158,530,4254,2938,5014,3466,794,526,4259,263,265,195,65,264,265,264,264,263,830,260,266,264,527,526,167,99,231,33,758,296,528,265,265,262,231,33,266,263,265,263,32,231,264,265,264,164,363,264,264,265,297,528,528,795,261,263,264,265,263,265,529,295,528,264,264,231,264,132,430,528,263,264,264,265,264,530,228,297,299,230,530,826,228,132,165,230,296,264,266,263,266,261,264,265,231,34,1619,527,527,528,1025,30,528,264,265,262,99,165,264,231,298,297,231,231,32,794,231,563,524,35,265,262,263,264,264,264,265,266,261,264,264,231,561,562,230,264,563,263,263,265,263,265,199,328,165,99,528,33,1056,763,261,263,265,531,264,261,32,266,262,528,264,530,263,263,264,264,266,526,264,795,987,429,432,295,527,530,494,564,260,198,33,67,231,264,494,33,527,531,32,493,34,230,298,496,33,263,197,33,33,264,264,265,266,31,231,296,132,331,66,529,229,231,66,495,297,233,31,264,264,266,196,34,32,298,98,663,525,199,66,231,33,34,494,263,267,31,265,232,261,34,197,34,263,33,132,132,760,563,263,263,263,266,266,260,563,230,32,133,395,231,231,33,1325,193,99,264,264,266,262,264,267,261,34,99,396,229,232,330,264,398,32,396,793,527,428,629,264,794,259,264,266,265,261,34,232,794,30,265,262,264,232,797,259,33,264,263,265,263,264,34,496,295,264,198,33,266,298,494,793,295,264,263,268,261,266,261,264,33,495,1355,229,297,67,462,230,301,161,595,296,266,262,264,264,528,266,296,230,297,231,794,561,231,296,231,329,528,564,988,496,560,263,264,531,262,264,32,264,264,463,32,34,527,264,231,32,529,265,230,33,527,267,230,32,298,494,34,230,32,264,133,595,32,564,260,200,31,34,530,261,231,33,264,266,262,199,32,35,527,264,264,33,496,31,264,264,265,264,264,265,263,265,263,263,265,263,264,264,265,264,265,264,263,296,530,497,293,264,264,264,267,262,529,526,528,264,34,230,530,296,231,264,263,264,35,229,33,265,230,34,263,231,33,264,528,264,1057,528,297,230,561,400,98,526,296,264,265,263,265,133,98,296,528,266,32,499,291,234,526,528,35,493,264,264,263,529,33,263,300,231,264,263,531,523,530,264,130,398,560,264,496,31,231,165,134,263,263,231,297,532,527,134,128,527,298,494,532,526,265,30,234,31,264,230,34,263,132,133,265,262,264,264,34,494,267,264,262,330,362,928,260,528,530,229,265,296,231,299,262,529,263,264,529,263,265,267,161,99,265,232,296,329,2079,496,32,266,261,266,265,528,263,263,34,231,794,31,264,130,134,526,529,265,198,64,528,265,264,264,263,264,34,230,297,133,631,29,531,260,200,32,33,364,167,260,231,33,264,530,232,30,497,295,264,532,260,264,33,363,133,264,33,230,264,268,30,263,132,133,131,265,133,263,527,297,267,229,263,827,130,101,564,226,34,263,231,301,228,263,297,264,264,265,265,262,264,231,297,264,34,231,263,265,296,231,266,561,229,33,797,259,232,297,230,264,33,230,34,233,297,262,231,33,528,100,165,264,262,298,494,35,266,263,229,32,265,131,133,263,233,267,29,264,528,264,265,263,265,230,32,794,462,67,426,364,33,264,496,31,264,265,264,499,29,529,262,297,266,497,261,267,294,230,34,264,232,33,262,264,265,530,262,529,262,531,262,33,496,262,267,261,528,33,826,1519,31,1057,793,231,33,2077,33,33,1057,992,30,829,227,1060,29,763,1319,2079,30,1852,261,33,8282,928,425,1356,16926,4094,10229]
app.post('/publish-slideshow', function(req, res) {
  var urls = req.body.urls;
  var token = req.body.token;
  var songPath = req.body.songPath;

  facebook.getPhotos({ token: token }).then(function() {
     slideshow.create({track: "./public/assets/audio/" + songPath, times: times}).then(function() {
      facebook.uploadVideo({outputFile: "output.mp4"});
    });
  });

  res.status(200).send(JSON.stringify({ data: 'all good in the hood' }));
});

app.get('*', function(req, res) {
  res.sendFile(path.resolve('dist/index.html'));
});

app.listen(serverSettings.port, function() {
  console.log('Server listening on port ' + serverSettings.port);
});
